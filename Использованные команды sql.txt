.open users.db
---
 CREATE TABLE users(
   ...> id integer PRIMARY KEY AUTOINCREMENT,
   ...> login text NOT NULL UNIQUE,
   ...> password text NOT NULL UNIQUE,
   ...> license_number text
   ...> );
---
.schema users
CREATE TABLE users(
id integer PRIMARY KEY AUTOINCREMENT,
login text NOT NULL UNIQUE,
password text NOT NULL UNIQUE,
license_number text
);
---
CREATE TABLE orders(
   ...>         id_user integer NOT NULL UNIQUE,
   ...>         id_good integer NOT NULL UNIQUE,
   ...>         FOREIGN KEY (id_user) REFERENCES users(id)
   ...> );
---
 CREATE TABLE goods(
   ...>         is_good integer PRIMARY KEY AUTOINCREMENT,
   ...>         good_name text NOT NULL UNIQUE,
   ...>         price integer,
   ...>         in_stock integer
   ...> );
---
 CREATE TABLE sale_places(
   ...>         place_id integer PRIMARY KEY AUTOINCREMENT,
   ...>         address text NOT NULL,
   ...>         metro text NOT NULL
   ...> );
---
sqlite> CREATE TABLE goods_to_places(
   ...>         id_of_place integer NOT NULL UNIQUE,
   ...>         good_id integer NOT NULL UNIQUE,
   ...>         FOREIGN KEY (id_of_place) REFERENCES sale_places(place_id),
   ...>         FOREIGN KEY (good_id) REFERENCES goods(id_good)
   ...> );
---
sqlite> ALTER TABLE goods RENAME COLUMN is_good TO id_good
   ...>
   ...> ;
---
UPDATE users 
	SET registration_date = 
	SUBSTR(registration_date, 7, 4) ||
	"-" ||
	SUBSTR(registration_date, 4, 2) ||
	"-" ||
	SUBSTR(registration_date, 1, 2);
---
SELECT id FROM users WHERE registration_date = (SELECT MAX(registration_date) FROM users);
---
SELECT DISTINCT SUBSTR(birth_date, 1, 4) from users;
---
SELECT SUM(in_stock) AS "total_items" FROM goods;
---
SELECT id FROM users WHERE (SELECT Cast(julianday("now") - julianday(registration_date) AS INTEGER)) <= 61; # вывести тех, кто зарегистрировался не позже двух месяцев назад
---
SELECT AVG(id) FROM users WHERE (SELECT Cast(julianday("now") - julianday(registration_date) AS INTEGER)) <= 61;
---
/*вывести покупки клиента и узнать, сколько он заплатил*/
SELECT
	(SELECT login FROM users WHERE id = id_user) AS client_login, 
	(SELECT good_name FROM goods WHERE id_good = ordered_good_id) AS good_name,
	(SELECT price FROM goods WHERE id_good = ordered_good_id) AS price
FROM orders;
---
/*Найти сколько всего в точке продажи товаров*/
SELECT
	(SELECT SUM(number_of_goods) FROM goods_to_places WHERE id_of_place = place_id) AS total_goods
FROM sale_places;
---
/*Соотнести, какая компания какой товар доставляет*/
SELECT
	(SELECT good_name FROM goods WHERE id_good = 
		(SELECT good_id FROM goods_to_places WHERE id_of_place = point_of_delivery)) AS goods,
	id_of_deliver
FROM delivers;
---
/*вывести пользователей, родившихся после 1 января 1980, и их покупки*/
SELECT
	login,
	(SELECT ordered_good_id FROM orders WHERE id_user = id) AS us_orders
FROM users
WHERE birth_date >= '1980-01-01';
---
/*Вывести пользователей, живущих в США, у которых больше 2 предупреждений*/
SELECT login, license_number, warnings FROM users WHERE warnings > 2 and country = 'USA';